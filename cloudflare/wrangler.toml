# Cloudflare Worker Configuration for ERA Agent
# NOTE: Cloudflare Containers is in BETA - API may change
# Last updated: October 2024

name = "era-agent"
main = "src/index.ts"
compatibility_date = "2024-10-01"
compatibility_flags = ["nodejs_compat"]

# Static assets (Astro site)
[assets]
directory = "./dist-astro"
binding = "ASSETS"

# Container configuration
[[containers]]
name = "era-agent-container"
class_name = "EraAgent"
image = "../era-agent/Dockerfile"
instance_type = "standard-1"
max_instances = 10

# Durable Object binding (required for Containers)
# This connects the Container to a Durable Object
[[durable_objects.bindings]]
name = "ERA_AGENT"
class_name = "EraAgent"

# Session Durable Object binding
# This handles session state and orchestration
[[durable_objects.bindings]]
name = "SESSIONS"
class_name = "SessionDO"

# Storage Registry Durable Object binding
# Tracks all storage resources created by sandboxed code
[[durable_objects.bindings]]
name = "STORAGE_REGISTRY"
class_name = "StorageRegistry"

# Migration (required for Durable Objects with Containers)
[[migrations]]
tag = "v1"
new_sqlite_classes = ["EraAgent"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["SessionDO"]

[[migrations]]
tag = "v3"
new_sqlite_classes = ["StorageRegistry"]

# R2 bucket for session file storage
[[r2_buckets]]
binding = "SESSIONS_BUCKET"
bucket_name = "era-sessions"

# R2 bucket for storage proxy (accessible from sandboxed code)
[[r2_buckets]]
binding = "ERA_R2"
bucket_name = "era-storage"

# KV namespace for storage proxy (accessible from sandboxed code)
[[kv_namespaces]]
binding = "ERA_KV"
id = "c91b21ce94a7417c9cbce40b61fc7a3e"

# D1 database for storage proxy (accessible from sandboxed code)
[[d1_databases]]
binding = "ERA_D1"
database_name = "era-storage"
database_id = "02edc2cd-1061-4d98-8163-74353265f5cc"

# Optional: Environment variables passed to your container
[vars]
AGENT_LOG_LEVEL = "info"

# Optional: Custom domains (configure after deployment)
# routes = [
#   { pattern = "api.yourdomain.com", zone_name = "yourdomain.com" }
# ]

# Workers settings
# [limits]
# cpu_ms = 10000  # Adjust based on your needs
