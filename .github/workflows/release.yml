name: Publish Release

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Verify build
        run: make agent

      - name: Clean build artifacts
        run: make clean

      - name: Create source archive
        id: archive
        run: |
          tag=${GITHUB_REF#refs/tags/}
          archive=release/era-agent-${tag}.tar.gz
          mkdir -p release
          tar \
            --exclude='./release' \
            --exclude='./.git' \
            --numeric-owner \
            --sort=name \
            --mtime='UTC 2020-01-01' \
            --transform="s,^,era-agent-${tag}/," \
            -czf "${archive}" .
          sha=$(sha256sum "${archive}" | cut -d' ' -f1)
          echo "archive=${archive}" >> "$GITHUB_OUTPUT"
          echo "sha=${sha}" >> "$GITHUB_OUTPUT"
          echo "${sha}  era-agent-${tag}.tar.gz" > release/era-agent-${tag}.sha256

      - name: Publish GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
          ARCHIVE_SHA: ${{ steps.archive.outputs.sha }}
        run: |
          set -euo pipefail
          notes_file=release/notes.txt
          printf '## Release assets\n\n- Source archive: `era-agent-%s.tar.gz`\n- SHA256: `%s`\n' \
            "${TAG_NAME}" "${ARCHIVE_SHA}" > "${notes_file}"
          gh release create "${TAG_NAME}" \
            "release/era-agent-${TAG_NAME}.tar.gz" \
            "release/era-agent-${TAG_NAME}.sha256" \
            --title "${TAG_NAME}" \
            --notes-file "${notes_file}"
